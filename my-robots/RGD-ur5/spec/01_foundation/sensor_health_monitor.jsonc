/**
 * ------------------------------------------------------------------
 * OPEN R.G.D. STANDARD v0.2 — REFERENCE IMPLEMENTATION
 * ------------------------------------------------------------------
 * FILE: sensor_health_monitor.jsonc
 * CONTEXT: 01_FOUNDATION (THE BODY — SENSOR HEALTH)
 *
 * PURPOSE:
 *   Defines health states, thresholds, and failover policies for
 *   all critical sensors. It acts as the "vital signs" monitor
 *   for perception and proprioception.
 *
 * HUMAN INTERPRETATION:
 *   - sensor_fidelity.jsonc  = how sensors are noisy/imperfect in sim
 *   - calibration.jsonc      = how a specific unit deviates from ideal
 *   - sensor_health_monitor  = when a sensor is HEALTHY, DEGRADED,
 *                              or FAILED and what the system must do.
 *
 * LLM INTERPRETATION:
 *   - DO NOT invent new health states. Use the ones defined in
 *     `health_state_definitions`.
 *   - Keys in `sensor_health_policies_map` MUST match sensors from
 *     description.jsonc → sensors_mounting_map.
 *   - This file defines policy and thresholds, not live readings.
 */

{
  // ==============================================================
  // 0. METADATA
  // ==============================================================

  "meta_group": {
    "health_profile_id_str": "default_sensor_health_v1",
    "version_semver_str": "1.0.0",
    "last_updated_iso8601_str": "2025-11-23T19:00:00Z",

    "related_files_map": {
      "description_ref_str": "01_foundation/description.jsonc",
      "sensor_fidelity_ref_str": "01_foundation/sensor_fidelity.jsonc",
      "runtime_validation_ref_str": "01_foundation/runtime_validation.jsonc",
      "safety_critical_ref_str": "04_volition/safety_critical.jsonc"
    }
  },

  // ==============================================================
  // 1. HEALTH STATE DEFINITIONS (GLOBAL)
  // ==============================================================

  "health_state_definitions": {
    "HEALTHY": {
      "description_str": "Sensor operating within expected noise and bias bounds.",
      "allowed_for_control_bool": true,
      "allowed_for_mapping_bool": true
    },

    "DEGRADED": {
      "description_str": "Sensor data is noisy or biased but still usable with caution.",
      "allowed_for_control_bool": false,
      "allowed_for_mapping_bool": true
    },

    "FAILED": {
      "description_str": "Sensor is considered unreliable; its data MUST NOT be used.",
      "allowed_for_control_bool": false,
      "allowed_for_mapping_bool": false
    }
  },

  // ==============================================================
  // 2. SENSOR-SPECIFIC HEALTH POLICIES
  //    Keys MUST match sensor IDs in description.jsonc
  // ==============================================================

  "sensor_health_policies_map": {

    // ------------------------------------------------------------
    // 2.1 HEAD RGBD CAMERA
    // ------------------------------------------------------------
    "head_camera_main": {
      "sensor_type_enum": "CAMERA_RGBD",

      // ---- BASIC HEALTH CHECKS ----
      "basic_checks": {
        "no_data_timeout_s_float": 0.5,             // if no frames for 0.5 s → at least DEGRADED
        "max_nan_ratio_pct_float": 10.0,            // if >10% NaN pixels in depth → DEGRADED
        "hard_fault_nan_ratio_pct_float": 40.0      // if >40% NaN → FAILED
      },

      // ---- CONSISTENCY CHECKS ----
      "consistency_checks": {
        "max_frame_drop_rate_pct_float": 20.0,      // over sliding window
        "max_timestamp_jitter_ms_float": 30.0       // irregular timestamps
      },

      // ---- THERMAL & BIAS DRIFT THRESHOLDS ----
      "drift_checks": {
        // If estimated extrinsic drift (via calibration tracker) exceeds:
        "max_pose_drift_m_float": 0.01,             // 1 cm extrinsic drift
        "max_pose_drift_rad_float": 0.01,           // ~0.57 deg
        "max_brightness_shift_pct_float": 25.0      // large global brightness shift = possible lens obstruction
      },

      // ---- HEALTH TRANSITION RULES ----
      "health_transition_rules": {
        "to_degraded_conditions": [
          "no_data_timeout_s > 0.5",
          "nan_ratio_pct > max_nan_ratio_pct_float",
          "frame_drop_rate_pct > max_frame_drop_rate_pct_float"
        ],
        "to_failed_conditions": [
          "nan_ratio_pct > hard_fault_nan_ratio_pct_float",
          "camera_link_lost_bool == true"
        ]
      },

      // ---- FAILOVER POLICY ----
      "failover_policy": {
        "on_degraded_enum": "USE_SENSOR_WITH_WEIGHTED_CONFIDENCE",
        "on_failed_enum": "DISABLE_VISION_FOR_CONTROL_USE_FUSION_ONLY",
        "notify_channels_list_str": [
          "04_volition/ledger.jsonc",
          "06_ether/consensus_reality.jsonc"
        ]
      }
    },

    // ------------------------------------------------------------
    // 2.2 TORSO IMU
    // ------------------------------------------------------------
    "torso_imu": {
      "sensor_type_enum": "IMU_6DOF",

      "basic_checks": {
        "no_data_timeout_s_float": 0.1,
        "max_nan_ratio_pct_float": 1.0
      },

      "consistency_checks": {
        "max_gyro_bias_rad_s_float": 0.05,          // estimated via online calibration
        "max_accel_bias_m_s2_float": 0.3,
        "max_variance_deviation_factor_float": 3.0  // variance > 3x expected → DEGRADED
      },

      "health_transition_rules": {
        "to_degraded_conditions": [
          "variance_factor > max_variance_deviation_factor_float",
          "gyro_bias_rad_s > max_gyro_bias_rad_s_float"
        ],
        "to_failed_conditions": [
          "no_data_timeout_s > 0.1",
          "nan_ratio_pct > max_nan_ratio_pct_float * 5.0"
        ]
      },

      "failover_policy": {
        "on_degraded_enum": "FALLBACK_TO_FUSED_STATE_ESTIMATOR", // e.g. leg odometry + vision
        "on_failed_enum": "ENTER_SAFE_BALANCE_MODE",
        "notify_channels_list_str": [
          "04_volition/safety_critical.jsonc"
        ]
      }
    },

    // ------------------------------------------------------------
    // 2.3 RIGHT WRIST FORCE/TORQUE
    // ------------------------------------------------------------
    "right_wrist_ft": {
      "sensor_type_enum": "FORCE_TORQUE_6DOF",

      "basic_checks": {
        "no_data_timeout_s_float": 0.2,
        "max_nan_ratio_pct_float": 1.0
      },

      "consistency_checks": {
        "max_preload_offset_n_float": 10.0,         // if zero force ≫ expected preload
        "max_noise_std_dev_n_float": 5.0            // very noisy → suspicious contact or damage
      },

      "health_transition_rules": {
        "to_degraded_conditions": [
          "preload_offset_n > max_preload_offset_n_float",
          "noise_std_dev_n > max_noise_std_dev_n_float"
        ],
        "to_failed_conditions": [
          "no_data_timeout_s > 0.2",
          "nan_ratio_pct > max_nan_ratio_pct_float * 3.0"
        ]
      },

      "failover_policy": {
        "on_degraded_enum": "LIMIT_CONTACT_FORCE_AND_SLOW_MOTION",
        "on_failed_enum": "DISABLE_FORCE_CONTROL_USE_POSITION_ONLY",
        "notify_channels_list_str": [
          "04_volition/safety_critical.jsonc",
          "04_volition/ledger.jsonc"
        ]
      }
    },

    // ------------------------------------------------------------
    // 2.4 CHEST LIDAR
    // ------------------------------------------------------------
    "chest_lidar": {
      "sensor_type_enum": "LIDAR_2D_SOLID_STATE",

      "basic_checks": {
        "no_data_timeout_s_float": 0.2,
        "max_nan_ratio_pct_float": 5.0
      },

      "consistency_checks": {
        "max_range_noise_m_float": 0.03,
        "min_effective_points_ratio_pct_float": 40.0   // at least 40% valid returns
      },

      "health_transition_rules": {
        "to_degraded_conditions": [
          "range_noise_m > max_range_noise_m_float",
          "effective_points_ratio_pct < min_effective_points_ratio_pct_float"
        ],
        "to_failed_conditions": [
          "no_data_timeout_s > 0.2",
          "nan_ratio_pct > max_nan_ratio_pct_float * 4.0"
        ]
      },

      "failover_policy": {
        "on_degraded_enum": "REDUCE_SPEED_AND_INCREASE_CLEARANCE",
        "on_failed_enum": "STOP_LOCOMOTION_IF_NO_ALTERNATIVE_SENSORS",
        "notify_channels_list_str": [
          "06_ether/consensus_reality.jsonc"
        ]
      }
    }
  }
}
